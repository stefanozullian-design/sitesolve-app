<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SiteSolve Pro - Participant</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        body { background-color: #030712; color: white; font-family: ui-sans-serif, system-ui; overflow-x: hidden; }
        .step-btn.active { background-color: #2563eb; border-color: #60a5fa; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
        .submit-overlay { display: none; position: fixed; inset: 0; background: rgba(3, 7, 18, 0.9); z-index: 100; align-items: center; justify-content: center; }
        .my-issue-card { background: white; color: black; border-radius: 12px; padding: 12px; border-left: 6px solid; position: relative; margin-bottom: 12px; white-space: pre-line; }
        #login-screen { position: fixed; inset: 0; background: #030712; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* Estilos Zona de Votación */
        #vote-canvas { height: 60vh; background: rgba(255,255,255,0.03); border: 2px dashed rgba(255,255,255,0.1); border-radius: 20px; position: relative; overflow: hidden; margin: 10px 0; }
        .rank-bubble { position: absolute; width: 85%; left: 7.5%; background: white; color: black; padding: 12px; border-radius: 10px; font-weight: 800; font-size: 11px; border-left: 8px solid; touch-action: none; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 10; }
        .y-axis-label { position: absolute; right: 10px; font-size: 8px; font-weight: 900; color: #4b5563; text-transform: uppercase; pointer-events: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="login-screen" style="display: none;">
        <h1 class="text-2xl font-black text-blue-500 italic mb-2">SITESOLVE PRO</h1>
        <input type="text" id="manualRoomInput" maxlength="6" placeholder="ROOM CODE" class="bg-gray-900 border-2 border-gray-800 rounded-2xl p-4 text-3xl font-black text-center text-blue-400 outline-none w-full max-w-[200px] uppercase mb-4">
        <button onclick="enterRoomManually()" class="bg-blue-600 w-full max-w-[200px] py-4 rounded-2xl font-black uppercase">Join</button>
    </div>

    <div id="main-app">
        <header class="flex justify-between items-center mb-4">
            <div>
                <h1 class="text-lg font-black text-blue-500 italic uppercase">SiteSolve Pro</h1>
                <p id="roomIndicator" class="text-[8px] text-gray-500 font-bold uppercase tracking-widest">---</p>
            </div>
            <div id="status-dot" class="w-2 h-2 bg-red-500 rounded-full"></div>
        </header>

        <div id="screen-input" class="space-y-4">
            <div id="steps-container" class="grid grid-cols-2 gap-2"></div>
            <textarea id="note-input" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-white text-sm h-24 outline-none" placeholder="Describe observation..."></textarea>
            <div id="cats-container" class="space-y-2"></div>
            <div id="my-contributions-list" class="mt-4"></div>
        </div>

        <div id="screen-ranking" class="hidden flex flex-col h-[85vh]">
            <div class="text-center mb-2">
                <h2 id="ranking-title" class="text-blue-400 font-black uppercase italic text-sm">Votación</h2>
                <div class="flex justify-between text-[8px] font-black text-gray-500 mt-1 uppercase">
                    <span id="label-top">↑ CRITICAL (100)</span>
                    <span id="label-bottom">MINOR (0) ↓</span>
                </div>
            </div>

            <div id="vote-canvas">
                <span class="y-axis-label top-4">100</span>
                <span class="y-axis-label bottom-4">0</span>
                </div>

            <button onclick="exitRanking()" class="w-full py-3 mt-4 text-[10px] font-black uppercase text-gray-500 bg-gray-900 rounded-xl">Back to Observations</button>
        </div>
    </div>

    <div id="successOverlay" class="submit-overlay flex-col">
        <p class="font-black text-green-500 uppercase">Sent!</p>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", authDomain: "issues-app-65527.firebaseapp.com", databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", projectId: "issues-app-65527", storageBucket: "issues-app-65527.firebasestorage.app", messagingSenderId: "103649380899", appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let room = new URLSearchParams(window.location.search).get('room');
        let selectedStep = "";
        let participantId = localStorage.getItem('participantId') || 'p_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('participantId', participantId);

        function initApp() {
            if (!room) { document.getElementById('login-screen').style.display = 'flex'; document.getElementById('main-app').style.display = 'none'; } 
            else { document.getElementById('login-screen').style.display = 'none'; startListening(); }
        }

        function enterRoomManually() {
            const code = document.getElementById('manualRoomInput').value.toUpperCase().trim();
            if (code.length === 6) window.location.search = "?room=" + code;
        }

        function startListening() {
            db.ref(`rooms/${room}/config`).on('value', snap => {
                const config = snap.val(); if (!config) return;
                document.getElementById('status-dot').className = "w-2 h-2 bg-green-500 rounded-full";
                document.getElementById('roomIndicator').innerText = "Room: " + room;
                document.getElementById('steps-container').innerHTML = (config.steps || []).map(step => `<button onclick="selectStep(this, '${step}')" class="step-btn bg-gray-900 border border-gray-800 p-2 rounded text-[9px] font-bold uppercase transition-all">${step}</button>`).join('');
                document.getElementById('cats-container').innerHTML = (config.cats || []).map(cat => `<button onclick="submitInstant('${cat.name}', '${cat.color}')" class="w-full p-3 rounded-xl text-[10px] font-black uppercase text-left flex justify-between items-center" style="background:${cat.color}20; color:${cat.color}; border:1px solid ${cat.color};">${cat.name} <span>→</span></button>`).join('');
            });

            db.ref(`rooms/${room}/notes`).on('value', snap => {
                const myNotes = Object.entries(snap.val() || {}).filter(([id, n]) => n.sender === participantId).reverse();
                document.getElementById('my-contributions-list').innerHTML = myNotes.map(([id, n]) => `<div class="my-issue-card" style="border-left-color:${n.color}"><div class="text-[7px] font-black uppercase text-gray-400">${n.step}</div><div class="text-[11px] font-bold">${n.text}</div></div>`).join('');
            });

            // ESCUCHAR CONTROL REMOTO DEL MODERADOR
            db.ref(`rooms/${room}/remote_control`).on('value', snap => {
                const control = snap.val();
                if (control && control.targetCategory) {
                    showRankingView(control.targetCategory, control.mode || 'importance');
                }
            });
        }

        function showRankingView(catName, mode) {
            document.getElementById('screen-input').classList.add('hidden');
            document.getElementById('screen-ranking').classList.remove('hidden');
            
            // Ajustar textos según el modo solicitado por el moderador
            const isImp = mode === 'importance';
            document.getElementById('ranking-title').innerText = (isImp ? "VOTE IMPORTANCE: " : "VOTE EASE (EFFORT): ") + catName;
            document.getElementById('label-top').innerText = isImp ? "↑ CRITICAL (100)" : "↑ EASY / LOW COST (100)";
            document.getElementById('label-bottom').innerText = isImp ? "MINOR (0) ↓" : "HARD / EXPENSIVE (0) ↓";

            const canvas = document.getElementById('vote-canvas');
            canvas.innerHTML = '<span class="y-axis-label top-4">100</span><span class="y-axis-label bottom-4">0</span>';

            db.ref(`rooms/${room}/matrix_nodes`).once('value', snap => {
                const nodes = Object.entries(snap.val() || {}).filter(([id, n]) => n.category === catName);
                
                nodes.forEach(([id, n], index) => {
                    const bubble = document.createElement('div');
                    bubble.className = "rank-bubble";
                    bubble.style.borderLeftColor = n.color;
                    bubble.innerText = n.text;
                    const initialY = 60 + (index * 60);
                    bubble.style.top = initialY + 'px';
                    bubble.setAttribute('data-id', id);
                    bubble.setAttribute('data-y', initialY);
                    canvas.appendChild(bubble);

                    interact(bubble).draggable({
                        listeners: {
                            move(event) {
                                const target = event.target;
                                let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                                y = Math.max(0, Math.min(y, canvas.offsetHeight - 60));
                                target.style.top = y + 'px';
                                target.setAttribute('data-y', y);
                            },
                            end(event) {
                                const target = event.target;
                                const canvasH = canvas.offsetHeight;
                                const currentY = parseFloat(target.getAttribute('data-y'));
                                // Cálculo 0-100 invertido (0px en top = 100 puntos)
                                const score = Math.round(100 - (currentY / (canvasH - 60)) * 100);
                                const nodeId = target.getAttribute('data-id');
                                
                                // Guardar voto en la rama específica (importance o effort)
                                db.ref(`rooms/${room}/participant_votes/${mode}/${participantId}/${nodeId}`).set(score);
                            }
                        }
                    });
                });
            });
        }

        function exitRanking() {
            document.getElementById('screen-input').classList.remove('hidden');
            document.getElementById('screen-ranking').classList.add('hidden');
        }

        function selectStep(btn, step) {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStep = step;
        }

        function submitInstant(catName, catColor) {
            const text = document.getElementById('note-input').value.trim();
            if (!selectedStep || !text) return alert("Select Step and type text!");
            db.ref(`rooms/${room}/notes`).push({ step: selectedStep, category: catName, color: catColor, text: text, sender: participantId, timestamp: Date.now() });
            document.getElementById('note-input').value = "";
            document.getElementById('successOverlay').style.display = 'flex';
            setTimeout(() => { document.getElementById('successOverlay').style.display = 'none'; }, 800);
        }

        initApp();
    </script>
</body>
</html>
