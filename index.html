<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SiteSolve Pro - Participant</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #030712; color: white; font-family: ui-sans-serif, system-ui; }
        .step-btn.active { background-color: #2563eb; border-color: #60a5fa; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
        
        .submit-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(3, 7, 18, 0.9);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        /* Modificado para soportar saltos de l√≠nea en bullet points */
        .my-issue-card { 
            background: white; 
            color: black; 
            white-space: pre-line; 
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="p-4 border-b border-white/5 flex justify-between items-center bg-gray-900/50">
        <div>
            <h1 id="roomTitle" class="text-xs font-black uppercase tracking-widest text-blue-400">SiteSolve Pro</h1>
            <p id="roomDisplay" class="text-[10px] text-gray-500 font-bold uppercase">Connecting...</p>
        </div>
        <div class="flex gap-2">
            <button onclick="showScreen('input')" class="p-2 bg-white/5 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            </button>
            <button onclick="showScreen('my-notes')" class="p-2 bg-white/5 rounded-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            </button>
        </div>
    </header>

    <div id="successOverlay" class="submit-overlay">
        <div class="text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <p class="font-black uppercase tracking-tighter text-xl">Observation Sent!</p>
        </div>
    </div>

    <main class="flex-1 overflow-hidden relative">
        
        <div id="screen-input" class="absolute inset-0 p-4 flex flex-col gap-4">
            <div class="flex-1 flex flex-col gap-3">
                <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest">1. Location / Process Step</label>
                <div id="stepContainer" class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    </div>

                <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest mt-2">2. What did you observe?</label>
                <textarea id="note-input" placeholder="Describe the issue, bottleneck or observation..." 
                    class="w-full flex-1 bg-white/5 border border-white/10 rounded-xl p-4 text-sm outline-none focus:border-blue-500 transition-all resize-none"></textarea>
            </div>

            <div id="catContainer" class="grid grid-cols-2 gap-2 pb-4">
                </div>
        </div>

        <div id="screen-my-notes" class="absolute inset-0 p-4 hidden flex-col">
            <h2 class="text-sm font-black uppercase mb-4 text-blue-400 italic">My Observations</h2>
            <div id="myNotesList" class="flex-1 overflow-y-auto space-y-3 pb-20">
                </div>
        </div>

    </main>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", 
            authDomain: "issues-app-65527.firebaseapp.com", 
            databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", 
            projectId: "issues-app-65527", 
            storageBucket: "issues-app-65527.firebasestorage.app", 
            messagingSenderId: "103649380899", 
            appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRoom = new URLSearchParams(window.location.search).get('room');
        let participantId = localStorage.getItem('participantId') || 'p_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('participantId', participantId);

        let selectedStep = null;
        let globalCats = [];

        if (currentRoom) {
            document.getElementById('roomDisplay').innerText = "Room: " + currentRoom;
            
            // Listen for config
            db.ref(`rooms/${currentRoom}/config`).on('value', snap => {
                const config = snap.val();
                if (config) {
                    document.getElementById('roomTitle').innerText = config.title || "Workshop";
                    renderSteps(config.steps || []);
                    renderCategories(config.cats || []);
                    globalCats = config.cats || [];
                }
            });

            // Listen for my notes
            db.ref(`rooms/${currentRoom}/notes`).on('value', snap => {
                const allNotes = snap.val() || {};
                const myNotes = Object.entries(allNotes)
                    .filter(([id, n]) => n.sender === participantId)
                    .map(([id, n]) => ({...n, id}));
                renderMyNotes(myNotes);
            });

        } else {
            document.body.innerHTML = `<div class="p-10 text-center font-black uppercase">No Room Code Found</div>`;
        }

        function renderSteps(steps) {
            const container = document.getElementById('stepContainer');
            container.innerHTML = steps.map(s => `
                <button onclick="selectStep(this, '${s}')" class="step-btn whitespace-nowrap px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-[10px] font-black uppercase">
                    ${s}
                </button>
            `).join('');
        }

        function renderCategories(cats) {
            const container = document.getElementById('catContainer');
            container.innerHTML = cats.map(c => `
                <button onclick="submitInstant('${c.name}', '${c.color}')" 
                    class="p-4 rounded-xl text-[10px] font-black uppercase text-center transition-transform active:scale-95"
                    style="background-color: ${c.color}; color: black;">
                    ${c.name}
                </button>
            `).join('');
        }

        function selectStep(btn, val) {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStep = val;
        }

        function showScreen(screen) {
            document.getElementById('screen-input').classList.toggle('hidden', screen !== 'input');
            document.getElementById('screen-my-notes').classList.toggle('hidden', screen !== 'my-notes');
        }

        function submitInstant(catName, catColor) {
            const text = document.getElementById('note-input').value.trim();
            if (!selectedStep) { alert("Please select a Location/Step first."); return; }
            if (!text) { alert("Please describe the observation."); return; }

            const overlay = document.getElementById('successOverlay');
            overlay.style.display = 'flex';

            const newNote = {
                step: selectedStep,
                category: catName,
                color: catColor,
                text: text,
                timestamp: Date.now(),
                sender: participantId
            };

            db.ref(`rooms/${currentRoom}/notes`).push(newNote).then(() => {
                document.getElementById('note-input').value = "";
                setTimeout(() => { overlay.style.display = 'none'; }, 800);
            });
        }

        function renderMyNotes(notes) {
            const container = document.getElementById('myNotesList');
            if (notes.length === 0) {
                container.innerHTML = `<p class="text-[10px] text-gray-500 uppercase font-bold text-center mt-10">No observations yet.</p>`;
                return;
            }

            container.innerHTML = notes.reverse().map(n => `
                <div class="my-issue-card p-4 rounded-xl border-l-8" style="border-left-color: ${n.color}">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-black uppercase text-gray-400 bg-gray-100 px-2 py-0.5 rounded">${n.step}</span>
                        <div class="flex gap-2">
                             <button onclick="toggleCat('${n.id}', '${n.category}')" class="text-[9px] font-black uppercase text-blue-600">Change Cat</button>
                             <button onclick="deleteNote('${n.id}')" class="text-[9px] font-black uppercase text-red-600">Delete</button>
                        </div>
                    </div>
                    <div class="text-xs font-bold leading-relaxed">${n.text}</div>
                </div>
            `).join('');
        }

        function toggleCat(id, currentCat) {
            const index = globalCats.findIndex(c => c.name === currentCat);
            const nextIndex = (index + 1) % globalCats.length;
            const nextCat = globalCats[nextIndex];
            db.ref(`rooms/${currentRoom}/notes/${id}`).update({
                category: nextCat.name,
                color: nextCat.color
            });
        }

        function deleteNote(id) {
            if (confirm("Delete this observation?")) {
                db.ref(`rooms/${currentRoom}/notes/${id}`).remove();
            }
        }
    </script>
</body>
</html>
