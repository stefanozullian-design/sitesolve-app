<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SiteSolve Pro - Participant</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { background-color: #030712; color: white; font-family: ui-sans-serif, system-ui; }
        .step-btn.active { background-color: #2563eb; border-color: #60a5fa; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
        .submit-overlay { display: none; position: fixed; inset: 0; background: rgba(3, 7, 18, 0.9); z-index: 100; align-items: center; justify-content: center; }
        .my-issue-card { background: white; color: black; border-radius: 12px; padding: 12px; border-left: 6px solid; position: relative; margin-bottom: 12px; white-space: pre-line; }
        .delete-btn { position: absolute; top: 8px; right: 12px; color: #ef4444; font-weight: 900; font-size: 14px; cursor: pointer; }
        #login-screen { position: fixed; inset: 0; background: #030712; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        
        /* Estilos para la lista de ranking */
        .rank-item-vote { background: white; color: black; padding: 15px; border-radius: 10px; font-weight: 800; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-left: 8px solid; margin-bottom: 8px; }
        .sortable-ghost { opacity: 0.3; background: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="login-screen" style="display: none;">
        <h1 class="text-2xl font-black text-blue-500 italic mb-2">SITESOLVE PRO</h1>
        <p class="text-gray-500 text-xs mb-8 uppercase font-bold tracking-widest">Enter Room Code</p>
        <input type="text" id="manualRoomInput" maxlength="6" placeholder="ABCDEF" class="bg-gray-900 border-2 border-gray-800 rounded-2xl p-4 text-3xl font-black text-center text-blue-400 outline-none focus:border-blue-500 w-full max-w-[200px] uppercase mb-4">
        <button onclick="enterRoomManually()" class="bg-blue-600 w-full max-w-[200px] py-4 rounded-2xl font-black uppercase shadow-lg shadow-blue-900/40">Join Workshop</button>
    </div>

    <div id="successOverlay" class="submit-overlay flex-col">
        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mb-4">
            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
        </div>
        <p class="font-black uppercase tracking-tighter text-xl text-green-500">Observation Sent</p>
    </div>

    <div id="main-app">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-xl font-black text-blue-500 italic uppercase leading-none">SiteSolve Pro</h1>
                <p id="roomIndicator" class="text-[9px] text-gray-500 font-bold uppercase tracking-widest mt-1">Room: ---</p>
            </div>
            <div id="status-dot" class="w-2 h-2 bg-red-500 rounded-full"></div>
        </header>

        <div id="screen-input" class="space-y-6 max-w-md mx-auto w-full pb-6">
            <section>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 block">1. Location / Step</label>
                <div id="steps-container" class="grid grid-cols-2 gap-2"></div>
            </section>
            <section>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 block">2. Describe Issue</label>
                <textarea id="note-input" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-white placeholder-gray-700 focus:border-blue-500 outline-none h-32 transition-all text-sm" placeholder="Type your observation here..."></textarea>
            </section>
            <section>
                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3 block">3. Tap Category to Submit</label>
                <div id="cats-container" class="grid grid-cols-1 gap-3"></div>
            </section>
            <hr class="border-gray-800 my-8">
            <section>
                <label class="text-[10px] font-black text-blue-400 uppercase tracking-[0.2em] mb-4 block flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span> My Sent Observations
                </label>
                <div id="my-contributions-list"></div>
            </section>
        </div>

        <div id="screen-ranking" class="hidden space-y-4 max-w-md mx-auto w-full pb-6">
            <div class="bg-blue-600/20 p-4 rounded-xl border border-blue-500/40">
                <h2 id="ranking-title" class="text-lg font-black text-blue-400 uppercase italic leading-tight">Ranking</h2>
                <p class="text-[10px] font-bold text-gray-400 uppercase mt-1">Arrastra hacia arriba lo más importante</p>
            </div>
            <div id="ranking-list" class="space-y-2"></div>
            <button onclick="exitRanking()" class="w-full py-3 text-[10px] font-black uppercase text-gray-500 border border-gray-800 rounded-xl">Volver a mis notas</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", authDomain: "issues-app-65527.firebaseapp.com", databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", projectId: "issues-app-65527", storageBucket: "issues-app-65527.firebasestorage.app", messagingSenderId: "103649380899", appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let room = new URLSearchParams(window.location.search).get('room');
        let selectedStep = "";
        let participantId = localStorage.getItem('participantId') || 'p_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('participantId', participantId);
        let sortableInstance = null;

        function initApp() {
            if (!room) {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            } else {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('roomIndicator').innerText = "Room: " + room;
                startListening();
            }
        }

        function enterRoomManually() {
            const inputCode = document.getElementById('manualRoomInput').value.toUpperCase().trim();
            if (inputCode.length === 6) { window.location.search = "?room=" + inputCode; } 
            else { alert("Please enter a valid 6-character code."); }
        }

        function startListening() {
            // Escuchar configuración (pasos y categorías)
            db.ref(`rooms/${room}/config`).on('value', snap => {
                const config = snap.val();
                if (!config) return;
                document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('steps-container').innerHTML = (config.steps || []).map(step => `
                    <button onclick="selectStep(this, '${step}')" class="step-btn bg-gray-900 border border-gray-800 p-3 rounded-lg text-[10px] font-bold uppercase transition-all">${step}</button>
                `).join('');
                document.getElementById('cats-container').innerHTML = (config.cats || []).map(cat => `
                    <button onclick="submitInstant('${cat.name}', '${cat.color}')" class="p-4 rounded-xl text-xs font-black uppercase border-b-4 active:translate-y-1 transition-all text-left flex justify-between items-center" style="background-color: ${cat.color}20; color: ${cat.color}; border-color: ${cat.color};">
                        ${cat.name} <span class="opacity-50 text-[18px]">→</span>
                    </button>
                `).join('');
            });

            // Escuchar mis notas
            db.ref(`rooms/${room}/notes`).on('value', snap => {
                const list = document.getElementById('my-contributions-list');
                const myNotes = Object.entries(snap.val() || {}).filter(([id, n]) => n.sender === participantId).reverse();
                list.innerHTML = myNotes.map(([id, n]) => `
                    <div class="my-issue-card" style="border-left-color: ${n.color}"><div class="delete-btn" onclick="deleteMyNote('${id}')">✕</div><div class="text-[8px] font-black uppercase text-gray-400 mb-1">${n.step}</div><div class="text-xs font-bold leading-tight">${n.text}</div></div>
                `).join('');
            });

            // ESCUCHAR CONTROL REMOTO DEL MODERADOR
            db.ref(`rooms/${room}/remote_control`).on('value', snap => {
                const control = snap.val();
                if (control && control.targetCategory) {
                    switchToRanking(control.targetCategory);
                }
            });
        }

        function switchToRanking(catName) {
            document.getElementById('screen-input').classList.add('hidden');
            document.getElementById('screen-ranking').classList.remove('hidden');
            document.getElementById('ranking-title').innerText = "PRIORITIZE: " + catName;
            
            db.ref(`rooms/${room}/matrix_nodes`).once('value', snap => {
                const nodes = snap.val() || {};
                const listContainer = document.getElementById('ranking-list');
                listContainer.innerHTML = '';
                
                const filtered = Object.entries(nodes).filter(([id, n]) => n.category === catName);
                
                filtered.forEach(([id, n]) => {
                    const el = document.createElement('div');
                    el.className = "rank-item-vote";
                    el.style.borderLeftColor = n.color;
                    el.setAttribute('data-id', id);
                    el.innerHTML = `<span>${n.text}</span> <span class="text-gray-300">☰</span>`;
                    listContainer.appendChild(el);
                });

                if(sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(listContainer, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: saveMyRanking
                });
                saveMyRanking(); // Guardar posición inicial
            });
        }

        function saveMyRanking() {
            const items = document.querySelectorAll('.rank-item-vote');
            const votes = {};
            items.forEach((item, index) => {
                const id = item.getAttribute('data-id');
                // 100 puntos al primero, bajando proporcionalmente
                const score = Math.round(100 - (index / (items.length - 1 || 1)) * 90);
                votes[id] = score;
            });
            db.ref(`rooms/${room}/participant_votes/${participantId}`).set(votes);
        }

        function exitRanking() {
            document.getElementById('screen-input').classList.remove('hidden');
            document.getElementById('screen-ranking').classList.add('hidden');
        }

        function selectStep(btn, step) {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStep = step;
        }

        function submitInstant(catName, catColor) {
            const text = document.getElementById('note-input').value.trim();
            if (!selectedStep || !text) { alert("Select Step and type your observation!"); return; }
            document.getElementById('successOverlay').style.display = 'flex';
            db.ref(`rooms/${room}/notes`).push({ step: selectedStep, category: catName, color: catColor, text: text, timestamp: Date.now(), sender: participantId }).then(() => {
                document.getElementById('note-input').value = "";
                setTimeout(() => { document.getElementById('successOverlay').style.display = 'none'; }, 800);
            });
        }

        function deleteMyNote(id) { if(confirm("Delete?")) db.ref(`rooms/${room}/notes/${id}`).remove(); }

        initApp();
    </script>
</body>
</html>
