<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SiteSolve Pro - Participant</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #030712; color: white; font-family: ui-sans-serif, system-ui; touch-action: manipulation; }
        .step-btn.active { background-color: #2563eb; border-color: #60a5fa; box-shadow: 0 0 15px rgba(37, 99, 235, 0.4); }
        .cat-btn.active { background-color: rgba(255,255,255,0.1); }
        .submit-overlay { display: none; position: fixed; inset: 0; background: rgba(3, 7, 18, 0.9); z-index: 100; align-items: center; justify-content: center; }
        .my-issue-card { background: white; color: black; border-radius: 12px; padding: 12px; border-left: 6px solid; margin-bottom: 12px; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <div id="invalid-room" class="fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center p-6 text-center" style="display: none;">
        <h1 class="text-4xl font-black text-red-500 mb-4">INVALID ROOM</h1>
        <p class="text-gray-400 text-sm uppercase tracking-widest">Esperando a que el moderador active la sala o el código es incorrecto.</p>
    </div>

    <header class="mb-6">
        <h1 id="workshop-title" class="text-2xl font-black italic uppercase text-blue-500">CONNECTING...</h1>
        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em]">Participant Terminal</p>
    </header>

    <div class="space-y-6 flex-1">
        <section>
            <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block italic">1. Select Process Step</label>
            <div id="step-container" class="grid grid-cols-2 gap-2">
                </div>
        </section>

        <section>
            <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block italic">2. Select Category</label>
            <div id="category-container" class="grid grid-cols-2 gap-2">
                </div>
        </section>

        <section>
            <label class="text-[10px] font-black text-gray-400 uppercase mb-2 block italic">3. Observation / Insight</label>
            <textarea id="note-input" rows="4" class="w-full bg-gray-900 border border-gray-800 rounded-xl p-4 text-sm font-medium focus:border-blue-500 outline-none transition-all text-white" placeholder="What did you observe?"></textarea>
        </section>

        <button onclick="submitNote()" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-[0.98] transition-all">Submit Observation</button>
    </div>

    <div id="successOverlay" class="submit-overlay">
        <div class="text-center">
            <div class="text-6xl mb-4">✅</div>
            <h2 class="text-2xl font-black uppercase italic">Received</h2>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", 
            authDomain: "issues-app-65527.firebaseapp.com", 
            databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", 
            projectId: "issues-app-65527", 
            storageBucket: "issues-app-65527.firebasestorage.app", 
            messagingSenderId: "103649380899", 
            appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentRoom = urlParams.get('room');
        const participantId = localStorage.getItem('participantId') || 'p_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('participantId', participantId);

        let selectedStep = null;
        let selectedCat = null;

        // VALIDACIÓN Y SINCRONIZACIÓN CON EL MODERADOR
        if (!currentRoom) {
            document.getElementById('invalid-room').style.display = 'flex';
        } else {
            // Escuchamos la configuración que el moderador envía en el botón "Sync & Start"
            db.ref(`rooms/${currentRoom}/config`).on('value', snap => {
                const config = snap.val();
                
                if (!config) {
                    document.getElementById('invalid-room').style.display = 'flex';
                    return;
                }

                document.getElementById('invalid-room').style.display = 'none';
                document.getElementById('workshop-title').innerText = config.title || "WORKSHOP SESSION";
                
                // Cargar Pasos
                const stepCont = document.getElementById('step-container');
                if (config.steps) {
                    stepCont.innerHTML = config.steps.map(s => `
                        <button onclick="selectStep(this, '${s}')" class="step-btn border border-gray-800 bg-gray-900/50 p-3 rounded-xl text-[10px] font-black uppercase text-left transition-all">
                            ${s}
                        </button>
                    `).join('');
                }

                // Cargar Categorías
                const catCont = document.getElementById('category-container');
                if (config.cats) {
                    catCont.innerHTML = config.cats.map(c => `
                        <button onclick="selectCat(this, '${c.name}', '${c.color}')" class="cat-btn border border-gray-800 bg-gray-900/50 p-3 rounded-xl text-[10px] font-black uppercase text-left flex items-center gap-2 transition-all">
                            <span class="w-2 h-2 rounded-full" style="background:${c.color}"></span> ${c.name}
                        </button>
                    `).join('');
                }
            });
        }

        function selectStep(btn, val) {
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedStep = val;
        }

        function selectCat(btn, name, color) {
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('active');
                b.style.borderColor = '#1f2937';
            });
            btn.classList.add('active');
            btn.style.borderColor = color;
            selectedCat = { name, color };
        }

        function submitNote() {
            const text = document.getElementById('note-input').value.trim();
            if (!selectedStep || !selectedCat || !text) {
                alert("Please select Step, Category and write your note!");
                return;
            }

            document.getElementById('successOverlay').style.display = 'flex';
            
            // Guardamos en la subcarpeta del Room para que el Moderador lo reciba
            db.ref(`rooms/${currentRoom}/notes`).push({
                step: selectedStep,
                category: selectedCat.name,
                color: selectedCat.color,
                text: text,
                timestamp: Date.now(),
                sender: participantId,
                impact: 50, // Valores por defecto para la matriz
                effort: 50
            }).then(() => {
                document.getElementById('note-input').value = "";
                setTimeout(() => { 
                    document.getElementById('successOverlay').style.display = 'none'; 
                }, 800);
            }).catch(err => {
                alert("Error: " + err.message);
                document.getElementById('successOverlay').style.display = 'none';
            });
        }
    </script>
</body>
</html>
