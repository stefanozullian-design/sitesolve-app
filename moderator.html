<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteSolve Pro - Moderator Master Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        body { background-color: #030712; color: white; overflow: hidden; font-family: ui-sans-serif, system-ui; }
        .tab-content { display: none !important; height: calc(100vh - 70px); width: 100%; }
        .tab-content.active { display: flex !important; flex-direction: column; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        nav button.active-tab { background-color: #1e3a8a !important; color: white !important; border-color: #3b82f6; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }
        .wall-item { background: white; color: black; padding: 12px; border-radius: 6px; font-size: 11px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); border-left-width: 8px; margin-bottom: 12px; touch-action: none; cursor: grab; z-index: 10; position: relative; }
        .step-badge { position: absolute; top: 8px; right: 8px; font-size: 7px; font-weight: 900; background: #f1f5f9; color: #64748b; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; border: 1px solid #e2e8f0; pointer-events: none; z-index: 20; }
        .rank-column { min-width: 300px; background: rgba(15, 23, 42, 0.6); border-radius: 12px; height: 100%; padding: 12px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; }
        .rank-item { background: white; color: black; padding: 10px; border-radius: 6px; font-weight: 900; font-size: 11px; text-transform: uppercase; cursor: grab; position: absolute; width: calc(100% - 24px); border-left-width: 8px; touch-action: none; z-index: 10; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .effort-node { position: absolute; width: 160px; background: white; color: black; padding: 8px; border-radius: 4px; font-size: 9px; font-weight: 800; border-left: 4px solid; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4); cursor: grab; touch-action: none; z-index: 10; transition: left 0.5s ease-out; }
        .matrix-container { width: 100%; aspect-ratio: 1/1; position: relative; background: #0f172a; border: 2px solid #334155; }
        .matrix-grid { position: absolute; inset: 0; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); }
        .matrix-cell { border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .matrix-cell::after { content: attr(data-label); position: absolute; top: 4px; left: 4px; font-size: 7px; font-weight: 900; color: #475569; text-transform: uppercase; opacity: 0.6; }
        .matrix-postit { position: absolute; width: 60px; height: 60px; background: white; color: black; font-size: 7px; font-weight: 800; padding: 6px; border-radius: 2px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); transform: translate(-50%, -50%); overflow: hidden; line-height: 1.1; border-left: 4px solid; z-index: 30; }
        .roadmap-column { min-width: 260px; background: rgba(15, 23, 42, 0.4); border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); position: relative; height: 100%; display: flex; flex-direction: column; }
        .roadmap-content-area { position: relative; flex: 1; margin-top: 10px; }
        .final-card-absolute { position: absolute; left: 0; right: 0; background: white; color: black; padding: 8px; border-radius: 4px; font-size: 10px; font-weight: 800; border-left: 6px solid; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); transition: top 0.5s ease-in-out; }
        .roi-tag { font-family: monospace; font-size: 9px; background: #f1f5f9; padding: 1px 4px; border-radius: 3px; color: #1e40af; font-weight: 900; }
        .scale-mark { position: absolute; left: -20px; font-size: 8px; color: #475569; font-weight: 800; pointer-events: none; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <nav class="bg-gray-900 border-b border-gray-800 p-2 flex items-center gap-4 h-[70px] text-[10px] font-bold shrink-0 z-50">
        <div class="flex items-center gap-3 px-3 border-r border-gray-800 h-full">
            <img src="ICON.png" alt="Logo" class="h-12 w-auto object-contain">
            <div class="hidden lg:block">
                <span class="text-blue-500 font-black italic uppercase block leading-none text-sm tracking-tighter">SiteSolve Pro</span>
                <span class="text-[8px] text-gray-500 uppercase tracking-widest">Master Hub</span>
            </div>
        </div>
        <div class="flex flex-1 gap-1 h-full py-1">
            <button onclick="showTab('setup')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-setup">1. Setup</button>
            <button onclick="showTab('synthesis')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-synthesis">2. Observation Wall</button>
            <button onclick="showTab('board')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-board">3. Importance</button>
            <button onclick="showTab('effort')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-effort">4. Effort</button>
            <button onclick="showTab('final')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-final">5. ROI Roadmap</button>
        </div>
    </nav>

    <div id="setup-tab" class="tab-content active p-6 overflow-y-auto">
        <div class="max-w-5xl mx-auto space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-blue-600/10 border border-blue-500/30 p-6 rounded-2xl flex flex-col gap-2">
                    <label class="text-[10px] font-black text-blue-400 uppercase tracking-[0.2em]">Workshop Identity</label>
                    <input type="text" id="workshopTitle" placeholder="NAME YOUR EXERCISE..." class="bg-transparent text-3xl font-black text-white outline-none uppercase italic">
                </div>
                <div class="bg-white/5 border border-white/10 p-4 rounded-2xl flex flex-col items-center justify-center gap-3">
                    <div id="qrcode" class="p-2 bg-white rounded-lg"></div>
                    <div class="text-center">
                        <p class="text-[9px] font-bold text-gray-400 uppercase">Room Code</p>
                        <p id="roomDisplay" class="text-2xl font-black tracking-widest text-blue-400">------</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center pt-4">
                <h2 class="text-xl font-black text-gray-500 italic uppercase">Configuration</h2>
                <div class="flex gap-4">
                    <button onclick="generateNewRoom()" class="text-blue-400 text-[10px] font-black uppercase px-4 border border-blue-900/30 rounded-lg">New Room Code</button>
                    <button onclick="resetAllData()" class="text-red-500 text-[10px] font-black uppercase px-4 border border-red-900/30 rounded-lg">Clear Session</button>
                    <button onclick="pushConfig()" class="bg-blue-600 px-8 py-3 rounded-xl font-black uppercase text-xs tracking-widest shadow-lg">Sync All Devices</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="setup-card bg-gray-900/50 p-6 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Process Flow</h3><button onclick="addRow('stepList', '')" class="text-blue-400 font-black uppercase">+ Add Step</button></div>
                    <div id="stepList" class="space-y-2"></div>
                </div>
                <div class="setup-card bg-gray-900/50 p-6 rounded-xl border border-white/5">
                    <div class="flex justify-between items-center mb-6"><h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest">Categories</h3><button onclick="addRow('categoryList', '', '#3b82f6')" class="text-blue-400 font-black uppercase">+ Add Category</button></div>
                    <div id="categoryList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="synthesis-tab" class="tab-content bg-[#020617]">
        <div class="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800">
            <h2 class="text-sm font-black text-blue-400 uppercase italic">Observation Wall</h2>
            <button onclick="approveSynthesis()" class="bg-green-600 px-6 py-2 rounded font-black uppercase text-[10px]">Send to Importance →</button>
        </div>
        <div id="columnContainer" class="flex-1 flex overflow-x-auto p-4 gap-4 scrollbar-hide"></div>
    </div>

    <div id="board-tab" class="tab-content bg-[#020617]">
        <div class="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800">
            <h2 class="text-sm font-black text-blue-400 uppercase italic leading-none">Importance Ranking</h2>
            <button onclick="showTab('effort')" class="bg-green-600 px-6 py-2 rounded font-black uppercase text-[10px]">Send to Effort →</button>
        </div>
        <div id="rankingContainer" class="flex-1 flex overflow-x-auto p-6 gap-6 scrollbar-hide"></div>
    </div>

    <div id="effort-tab" class="tab-content bg-[#020617]">
        <div class="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center shrink-0">
            <h2 class="text-sm font-black text-orange-400 uppercase italic">Effort Calibration</h2>
            <div id="effortCatNav" class="flex gap-2"></div>
        </div>
        <div class="flex-1 relative overflow-hidden">
            <div id="effortWorkingArea" class="absolute inset-0 p-6"></div>
            <div class="absolute bottom-4 left-0 right-0 flex justify-between px-10 pointer-events-none">
                <span class="text-[10px] font-black text-gray-500 uppercase">← High Effort (Hard)</span>
                <span class="text-[10px] font-black text-gray-500 uppercase">Low Effort (Easy) →</span>
            </div>
        </div>
    </div>

    <div id="final-tab" class="tab-content bg-[#020617] flex-row overflow-hidden">
        <div id="pdf-area" class="flex-1 flex flex-row p-4 gap-4 overflow-hidden">
            <div class="flex-1 flex flex-col min-w-0">
                <div class="mb-4 flex justify-between items-center">
                    <h2 class="text-sm font-black text-green-400 uppercase italic">Strategic Roadmap</h2>
                    <button onclick="exportToPDF()" class="bg-white text-black px-4 py-1 rounded font-black uppercase text-[10px]">Export PDF</button>
                </div>
                <div id="roadmapContainer" class="flex-1 flex overflow-x-auto gap-12 p-8 scrollbar-hide"></div>
            </div>
            <div class="w-96 flex flex-col gap-4 shrink-0">
                <div class="matrix-container" id="matrixContainer">
                    <div class="matrix-grid">
                        <div class="matrix-cell" data-label="Golden Ticket"></div><div class="matrix-cell" data-label="Strategic Win"></div><div class="matrix-cell" data-label="Major Project"></div>
                        <div class="matrix-cell" data-label="Quick Win"></div><div class="matrix-cell" data-label="Tactical"></div><div class="matrix-cell" data-label="Hard Slog"></div>
                        <div class="matrix-cell" data-label="Why Not?"></div><div class="matrix-cell" data-label="Filler"></div><div class="matrix-cell" data-label="Money Pit"></div>
                    </div>
                    <div id="matrixPoints" class="absolute inset-0 pointer-events-none"></div>
                </div>
                <div id="masterRankList" class="flex-1 overflow-y-auto bg-gray-900/50 rounded-xl p-4 border border-white/5"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", authDomain: "issues-app-65527.firebaseapp.com", databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", projectId: "issues-app-65527", storageBucket: "issues-app-65527.firebasestorage.app", messagingSenderId: "103649380899", appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRoom = "";
        let currentEffortCat = null;

        function initRoom(code) {
            currentRoom = code;
            localStorage.setItem('currentRoomCode', code);
            document.getElementById('roomDisplay').innerText = code;
            const baseUrl = window.location.href.split('moderator.html')[0];
            const qrcodeContainer = document.getElementById("qrcode");
            qrcodeContainer.innerHTML = "";
            new QRCode(qrcodeContainer, { text: baseUrl + "index.html?room=" + code, width: 100, height: 100 });
            
            db.ref(`rooms/${code}/config`).on('value', snap => {
                const config = snap.val();
                if (config && config.title) document.getElementById('workshopTitle').value = config.title;
            });
            renderWall();
        }

        document.getElementById('workshopTitle').addEventListener('input', (e) => {
            if(currentRoom) db.ref(`rooms/${currentRoom}/config`).update({ title: e.target.value });
        });

        function generateNewRoom() {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let result = "";
            for (let i = 0; i < 6; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            initRoom(result);
        }

        function addRow(containerId, name = "", color = null) {
            const container = document.getElementById(containerId);
            const row = document.createElement('div'); row.className = "row-item flex gap-2 p-2 bg-gray-800 rounded mb-2";
            row.innerHTML = `<div class="drag-handle cursor-grab">⋮⋮</div>${color ? `<input type="color" value="${color}" class="bg-transparent">` : ''}<input type="text" value="${name}" class="bg-transparent flex-1 outline-none text-xs font-bold uppercase"><div onclick="this.parentElement.remove()" class="cursor-pointer text-red-500">✕</div>`;
            container.appendChild(row);
        }

        function pushConfig() {
            if(!currentRoom) return;
            const steps = Array.from(document.querySelectorAll('#stepList input[type="text"]')).map(i => i.value);
            const cats = Array.from(document.querySelectorAll('#categoryList .row-item')).map(r => ({ name: r.querySelector('input[type="text"]').value, color: r.querySelector('input[type="color"]').value }));
            db.ref(`rooms/${currentRoom}/config`).update({ steps, cats }).then(() => alert("Synced!"));
        }

        function updateMergeTitle(id, newTitle) {
            db.ref(`rooms/${currentRoom}/notes/${id}`).update({ mergeTitle: newTitle });
        }

        function initWallInteractions() {
            interact('.wall-item').draggable({
                listeners: {
                    move(event) {
                        const target = event.target;
                        const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                        target.style.transform = `translate(${x}px, ${y}px)`;
                        target.setAttribute('data-x', x);
                        target.setAttribute('data-y', y);
                    }
                }
            }).dropzone({
                accept: '.wall-item', overlap: 0.5,
                ondrop(event) {
                    const draggedId = event.relatedTarget.getAttribute('data-id');
                    const targetId = event.target.getAttribute('data-id');
                    if (draggedId && targetId && draggedId !== targetId) {
                        const sourceRef = db.ref(`rooms/${currentRoom}/notes/${draggedId}`);
                        const targetRef = db.ref(`rooms/${currentRoom}/notes/${targetId}`);
                        Promise.all([sourceRef.get(), targetRef.get()]).then(results => {
                            const sourceData = results[0].val(); const targetData = results[1].val();
                            if (sourceData && targetData) {
                                const format = (txt) => txt.split('\n').map(line => line.trim().startsWith('•') ? line.trim() : `• ${line.trim()}`).join('\n');
                                const combinedText = format(targetData.text) + '\n' + format(sourceData.text);
                                targetRef.update({ text: combinedText }); sourceRef.remove();
                            }
                        });
                    }
                }
            });
        }

        function renderWall() {
            const container = document.getElementById('columnContainer');
            db.ref(`rooms/${currentRoom}/config`).on('value', cSnap => {
                const c = cSnap.val() || {};
                db.ref(`rooms/${currentRoom}/notes`).on('value', nSnap => {
                    const notes = nSnap.val() || {};
                    container.innerHTML = (c.steps || []).map(step => {
                        const stepNotes = Object.entries(notes).filter(([id, n]) => n.step === step);
                        return `<div class="step-column min-w-[300px] flex flex-col bg-gray-900/40 rounded-xl border border-white/5 h-full"><div class="p-3 font-black text-[10px] uppercase text-blue-400 border-b border-gray-800">${step}</div><div class="p-3 overflow-y-auto">${stepNotes.map(([id, n]) => `
                            <div class="wall-item" style="border-left-color:${n.color}" data-id="${id}">
                                <div class="step-badge">${n.step}</div>
                                ${n.text.includes('•') ? `<input type="text" placeholder="Add Merge Title..." value="${n.mergeTitle || ''}" onchange="updateMergeTitle('${id}', this.value)" class="w-full border-b border-gray-200 mb-2 font-black uppercase text-[10px] outline-none">` : ''}
                                <div class="whitespace-pre-line">${n.text}</div>
                            </div>`).join('')}</div></div>`;
                    }).join('');
                    initWallInteractions();
                });
            });
        }

        function approveSynthesis() {
            db.ref(`rooms/${currentRoom}/notes`).once('value', snap => {
                const nodes = {}; const notes = snap.val() || {};
                Object.entries(notes).forEach(([id, n], i) => { 
                    const finalDisplay = n.mergeTitle ? n.mergeTitle.toUpperCase() : n.text;
                    nodes[id] = { text: finalDisplay, color: n.color, category: n.category, step: n.step, impact: 50, effort: 50 }; 
                });
                db.ref(`rooms/${currentRoom}/matrix_nodes`).set(nodes).then(() => showTab('board'));
            });
        }

        function setParticipantView(categoryName, type) {
            db.ref(`rooms/${currentRoom}/remote_control`).set({ targetCategory: categoryName, mode: type, timestamp: Date.now() });
        }

        function renderRankingBoard() {
            const container = document.getElementById('rankingContainer');
            db.ref(`rooms/${currentRoom}/config`).once('value', cSnap => {
                const config = cSnap.val() || {};
                container.innerHTML = (config.cats || []).map(cat => `
                    <div class="rank-column flex flex-col">
                        <button onclick="setParticipantView('${cat.name}', 'importance')" class="mb-4 bg-blue-600 hover:bg-blue-500 py-2 rounded text-[9px] font-black uppercase transition-all shadow-lg">Prioritize ${cat.name}</button>
                        <div class="rank-slot flex-1 relative" data-cat="${cat.name}"></div>
                    </div>`).join('');

                db.ref(`rooms/${currentRoom}/matrix_nodes`).on('value', nSnap => {
                    const nodes = nSnap.val() || {};
                    db.ref(`rooms/${currentRoom}/participant_votes/importance`).on('value', vSnap => {
                        const allVotes = vSnap.val() || {};
                        document.querySelectorAll('.rank-slot').forEach(slot => {
                            const cat = slot.getAttribute('data-cat'); slot.innerHTML = '';
                            Object.entries(nodes).filter(([id, d]) => d.category === cat).forEach(([id, d]) => {
                                let finalImpact = d.impact || 50;
                                const nodeVotes = Object.values(allVotes).map(v => v[id]).filter(v => v !== undefined);
                                if (nodeVotes.length > 0) finalImpact = Math.round(nodeVotes.reduce((a, b) => a + b, 0) / nodeVotes.length);
                                const el = document.createElement('div'); el.className = "rank-item"; el.style.borderLeftColor = d.color;
                                const yPos = (100 - finalImpact) * ((slot.offsetHeight - 50) / 100);
                                el.style.top = yPos + 'px'; el.innerHTML = `<div class="step-badge">${d.step}</div>${d.text} <span class="roi-tag ml-auto">${finalImpact}%</span>`;
                                slot.appendChild(el);
                                db.ref(`rooms/${currentRoom}/matrix_nodes/${id}`).update({ impact: finalImpact });
                            });
                        });
                    });
                });
            });
        }

        function renderEffort() {
            const nav = document.getElementById('effortCatNav'); const area = document.getElementById('effortWorkingArea');
            db.ref(`rooms/${currentRoom}/config`).once('value', cSnap => {
                const c = cSnap.val() || {};
                nav.innerHTML = (c.cats || []).map(cat => `<button onclick="setParticipantView('${cat.name}', 'effort'); currentEffortCat='${cat.name}'; renderEffort();" class="px-3 py-1 rounded text-[9px] font-black uppercase border transition-all" style="border-color:${cat.color}; color:${currentEffortCat===cat.name?'black':cat.color}; background:${currentEffortCat===cat.name?cat.color:'transparent'}">${cat.name}</button>`).join('');
                db.ref(`rooms/${currentRoom}/matrix_nodes`).on('value', nSnap => {
                    area.innerHTML = ''; const nodes = nSnap.val() || {};
                    db.ref(`rooms/${currentRoom}/participant_votes/effort`).on('value', vSnap => {
                        const allVotes = vSnap.val() || {};
                        Object.entries(nodes).filter(([id, d]) => !currentEffortCat || d.category === currentEffortCat).forEach(([id, d], i) => {
                            let finalEffort = d.effort || 50;
                            const nodeVotes = Object.values(allVotes).map(v => v[id]).filter(v => v !== undefined);
                            if (nodeVotes.length > 0) finalEffort = Math.round(nodeVotes.reduce((a, b) => a + b, 0) / nodeVotes.length);
                            const el = document.createElement('div'); el.className = "effort-node"; el.style.borderLeftColor = d.color;
                            const xPos = (finalEffort / 100) * (area.offsetWidth - 170);
                            el.style.left = xPos + 'px'; el.style.top = (20 + (i * 45)) + 'px';
                            el.innerHTML = `<div class="truncate">${d.text}</div><div class="text-[7px] text-blue-600 mt-1">EASE: ${finalEffort}%</div>`;
                            area.appendChild(el);
                            db.ref(`rooms/${currentRoom}/matrix_nodes/${id}`).update({ effort: finalEffort });
                        });
                    });
                });
            });
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmapContainer'); const masterList = document.getElementById('masterRankList'); const matrixPoints = document.getElementById('matrixPoints');
            container.innerHTML = ''; masterList.innerHTML = ''; matrixPoints.innerHTML = '';
            db.ref(`rooms/${currentRoom}/config`).once('value', cSnap => {
                const c = cSnap.val() || {};
                db.ref(`rooms/${currentRoom}/matrix_nodes`).once('value', nSnap => {
                    const nodes = Object.entries(nSnap.val() || {}).map(([id, n]) => ({ ...n, id, roi: Math.round(((n.impact || 0) * (n.effort || 0)) / 100) }));
                    const matrixBox = document.getElementById('matrixContainer'); const mw = matrixBox.offsetWidth; const mh = matrixBox.offsetHeight;
                    nodes.forEach(n => {
                        const dot = document.createElement('div'); dot.className = "matrix-postit"; dot.style.borderLeftColor = n.color;
                        const x = ((n.effort || 0) / 100) * mw; const y = mh - (((n.impact || 0) / 100) * mh);
                        dot.style.left = Math.max(35, Math.min(x, mw - 35)) + 'px'; dot.style.top = Math.max(35, Math.min(y, mh - 35)) + 'px';
                        dot.innerHTML = n.text; matrixPoints.appendChild(dot);
                    });
                    (c.cats || []).forEach(cat => {
                        const col = document.createElement('div'); col.className = "roadmap-column";
                        col.innerHTML = `<h3 class="text-[10px] font-black uppercase text-center border-b border-white/10 pb-2" style="color:${cat.color}">${cat.name}</h3><div class="roadmap-content-area" style="height:500px"></div>`;
                        container.appendChild(col);
                        const contentArea = col.querySelector('.roadmap-content-area');
                        nodes.filter(n => n.category === cat.name).forEach(n => {
                            const card = document.createElement('div'); card.className = "final-card-absolute"; card.style.borderLeftColor = n.color;
                            card.style.top = (100 - n.impact) * (500 / 100) + "px";
                            card.innerHTML = `<span>${n.text}</span><span class="roi-tag">${n.impact}%</span>`;
                            contentArea.appendChild(card);
                        });
                    });
                    nodes.sort((a,b) => b.roi - a.roi).forEach((n, i) => { masterList.innerHTML += `<div class="flex items-center gap-2 mb-2 p-2 bg-white/5 rounded text-[9px] uppercase font-bold" style="border-left: 3px solid ${n.color}">#${i+1} ${n.text} <span class="ml-auto roi-tag">${n.roi} ROI</span></div>`; });
                });
            });
        }

        function showTab(tId) {
            document.querySelectorAll('.tab-content, nav button').forEach(el => el.classList.remove('active', 'active-tab'));
            document.getElementById(tId + '-tab').classList.add('active');
            document.getElementById('btn-' + tId).classList.add('active-tab');
            if(!currentRoom) return;
            if(tId === 'synthesis') renderWall();
            if(tId === 'board') renderRankingBoard();
            if(tId === 'effort') renderEffort();
            if(tId === 'final') renderRoadmap();
        }

        function exportToPDF() { html2pdf().from(document.getElementById('pdf-area')).save(`SiteSolve_${currentRoom}.pdf`); }
        function resetAllData() { if(confirm("Clear All?")) { db.ref(`rooms/${currentRoom}`).remove().then(() => { localStorage.removeItem('currentRoomCode'); location.reload(); }); } }

        window.addEventListener('load', () => { 
            const savedRoom = localStorage.getItem('currentRoomCode');
            if (savedRoom) initRoom(savedRoom); else generateNewRoom();
        });
    </script>
</body>
</html>
