<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteSolve Pro - Moderator Hub</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        .post-it { touch-action: none; cursor: grab; z-index: 50; transition: box-shadow 0.2s; position: absolute; }
        .post-it:active { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5); cursor: grabbing; z-index: 100; }
        .matrix-bg { background-image: radial-gradient(#374151 2px, transparent 1px); background-size: 50px 50px; }
        .tab-content { display: none; height: calc(100vh - 60px); }
        .tab-content.active { display: flex; flex-direction: column; }
        .step-column { min-width: 280px; max-width: 280px; flex-shrink: 0; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .category-row { transition: all 0.2s; }
        .category-row:hover { border-color: #4b5563; }
        
        /* Drag & Merge Styles */
        .wall-item { cursor: grab; touch-action: none; transition: transform 0.1s; z-index: 10; }
        .drop-target { border: 2px dashed #3b82f6 !important; transform: scale(1.05); background: #f1f5f9 !important; }
    </style>
</head>
<body class="bg-gray-950 text-white h-screen overflow-hidden font-sans">

    <nav class="bg-gray-900 border-b border-gray-800 p-2 flex gap-1 h-[60px] text-[10px] font-bold">
        <button onclick="showTab('setup')" class="flex-1 rounded bg-blue-600 uppercase" id="btn-setup">1. Setup & Config</button>
        <button onclick="showTab('synthesis')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-synthesis">2. Observation Wall</button>
        <button onclick="showTab('board')" class="flex-1 rounded bg-gray-800 uppercase" id="btn-board">3. Prioritize Matrix</button>
    </nav>

    <div id="setup-tab" class="tab-content active p-6 overflow-y-auto">
        <div class="max-w-6xl mx-auto space-y-6">
            <div class="flex justify-between items-end">
                <h1 class="text-2xl font-black text-blue-400 italic leading-none uppercase tracking-tighter">Moderator Control</h1>
                <div class="bg-blue-900/30 px-6 py-2 rounded-xl border border-blue-500/50 text-center">
                    <span class="text-[9px] uppercase text-blue-400 font-bold block mb-1 tracking-widest">Active Notes</span>
                    <span id="issueCount" class="font-black text-2xl text-white leading-none">0</span>
                </div>
            </div>
            
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                <h3 class="text-[10px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Gemini API Key</h3>
                <input type="password" id="apiKeyInput" placeholder="Enter API Key..." class="w-full bg-black p-3 rounded text-[12px] text-green-400 border border-gray-700 outline-none font-mono">
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <h3 class="text-[10px] font-bold text-gray-500 mb-3 uppercase tracking-widest text-center">Process Steps</h3>
                    <textarea id="processInput" class="w-full bg-black p-4 rounded text-xs h-48 font-mono text-blue-300 outline-none border border-gray-800">Receiving&#10;Inbound Inspection&#10;Putaway&#10;Picking&#10;Packing&#10;Dispatch</textarea>
                </div>

                <div class="lg:col-span-2 bg-gray-900 p-4 rounded-xl border border-gray-800">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Observation Categories</h3>
                        <button onclick="addCategoryRow()" class="text-[10px] bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded font-black uppercase tracking-widest transition-colors">+ Add New</button>
                    </div>
                    <div id="categoryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 overflow-y-auto max-h-56 pr-2">
                        <div class="flex gap-2 category-row items-center bg-black/40 p-2 rounded border border-gray-800">
                            <input type="color" value="#ef4444" class="w-5 h-5 bg-transparent border-none cursor-pointer">
                            <input type="text" value="Safety" class="flex-1 bg-transparent text-[11px] cat-name font-bold outline-none">
                            <button onclick="deleteCategory(this)" class="text-red-500 hover:text-red-300 px-2 font-black transition-colors">✕</button>
                        </div>
                        <div class="flex gap-2 category-row items-center bg-black/40 p-2 rounded border border-gray-800">
                            <input type="color" value="#fbbf24" class="w-5 h-5 bg-transparent border-none cursor-pointer">
                            <input type="text" value="Maintenance" class="flex-1 bg-transparent text-[11px] cat-name font-bold outline-none">
                            <button onclick="deleteCategory(this)" class="text-red-500 hover:text-red-300 px-2 font-black transition-colors">✕</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <button onclick="pushConfig()" class="col-span-2 bg-blue-600 hover:bg-blue-700 p-4 rounded-xl font-black uppercase text-[12px] shadow-lg tracking-widest transition-all">Sync Configuration to Devices</button>
                <button onclick="generateTestData()" class="bg-gray-800 hover:bg-gray-700 p-4 rounded-xl font-bold uppercase text-[10px] border border-gray-700">Add Test Data</button>
                <button onclick="resetEverything()" class="bg-red-900/10 border border-red-900/30 p-4 rounded-xl text-red-500 text-[10px] font-bold uppercase hover:bg-red-900/20 transition-colors">Reset All Session Data</button>
            </div>
        </div>
    </div>

    <div id="synthesis-tab" class="tab-content flex flex-col h-full bg-gray-950">
        <div class="flex justify-between items-center p-4 bg-gray-900 border-b border-gray-800 shrink-0">
            <h2 class="text-lg font-black text-blue-400 uppercase italic">Observation Wall</h2>
            <div class="flex gap-2">
                <button id="aiBtn" onclick="runAiSynthesis()" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg font-bold text-[10px] uppercase">AI Clustering ✨</button>
                <button onclick="approveSynthesis()" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-bold text-[10px] uppercase">Send to Matrix</button>
            </div>
        </div>
        <div id="clusterContainer" class="flex-1 overflow-x-auto p-4 flex gap-6 bg-gray-950"></div>
    </div>

    <div id="board-tab" class="tab-content relative">
        <div id="matrix" class="flex-grow relative bg-gray-950 matrix-bg overflow-hidden">
            <div class="absolute top-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-gray-700 uppercase tracking-[0.4em]">High Impact</div>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-[10px] font-black text-gray-700 uppercase tracking-[0.4em]">Low Impact</div>
            <div class="absolute left-4 top-1/2 -rotate-90 origin-left text-[10px] font-black text-gray-700 uppercase tracking-[0.4em]">High Effort</div>
            <div class="absolute right-4 top-1/2 rotate-90 origin-right text-[10px] font-black text-gray-700 uppercase tracking-[0.4em]">Low Effort</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw",
            authDomain: "issues-app-65527.firebaseapp.com",
            databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com",
            projectId: "issues-app-65527",
            storageBucket: "issues-app-65527.firebasestorage.app",
            messagingSenderId: "103649380899",
            appId: "1:103649380899:web:f8f9131b9a4123d2e93f96"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let allNotes = [];
        let currentActiveTab = 'setup';

        // --- REAL-TIME SYNC ---
        db.ref('notes').on('value', snap => {
            const data = snap.val();
            // Store as array with IDs for merging logic
            allNotes = data ? Object.entries(data).map(([id, val]) => ({ id, ...val })) : [];
            document.getElementById('issueCount').innerText = allNotes.length;
            if (currentActiveTab === 'synthesis') renderRawWall();
        });

        db.ref('matrix_nodes').on('value', snap => {
            if (currentActiveTab === 'board') syncMatrixUI(snap.val());
        });

        // --- TAB LOGIC ---
        function showTab(t) {
            currentActiveTab = t;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(t + '-tab').classList.add('active');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('bg-blue-600', 'bg-gray-800'));
            document.getElementById('btn-' + t).classList.replace('bg-gray-800', 'bg-blue-600');
            if(t === 'synthesis') renderRawWall();
            if(t === 'board') db.ref('matrix_nodes').once('value', snap => syncMatrixUI(snap.val()));
        }

        // --- OBSERVATION WALL (WITH MERGE) ---
        function renderRawWall() {
            const container = document.getElementById('clusterContainer');
            if (allNotes.length === 0) { container.innerHTML = "<div class='w-full text-center p-20 text-gray-700 uppercase font-black'>Awaiting Participant Feedback...</div>"; return; }
            
            const steps = document.getElementById('processInput').value.split('\n').filter(s => s.trim() !== "");
            container.innerHTML = steps.map(step => `
                <div class="step-column bg-gray-900/30 rounded-xl border border-gray-800 p-4 flex flex-col h-full">
                    <h3 class="text-blue-400 font-black text-xs uppercase mb-4 border-b border-blue-900/30 pb-2">${step}</h3>
                    <div class="space-y-3 overflow-y-auto no-scrollbar flex-1">
                        ${allNotes.filter(n => n.step === step).map(n => `
                            <div class="wall-item p-3 bg-white text-black text-[10px] font-bold rounded shadow-xl border-l-4" 
                                 style="border-color:${n.color}" data-id="${n.id}">
                                ${Array.isArray(n.text) ? n.text.map(t => `• ${t}`).join('<br>') : n.text}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Initialize Drag & Drop for Wall Items
            interact('.wall-item').draggable({
                inertia: true,
                listeners: {
                    move(event) {
                        const x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;
                        event.target.style.transform = `translate(${x}px, ${y}px)`;
                        event.target.setAttribute('data-x', x);
                        event.target.setAttribute('data-y', y);
                    }
                }
            }).dropzone({
                accept: '.wall-item',
                overlap: 0.5,
                ondragenter: e => e.target.classList.add('drop-target'),
                ondragleave: e => e.target.classList.remove('drop-target'),
                ondrop: e => {
                    e.target.classList.remove('drop-target');
                    const draggedId = e.relatedTarget.getAttribute('data-id');
                    const targetId = e.target.getAttribute('data-id');
                    if(draggedId && targetId && draggedId !== targetId) mergeNotes(draggedId, targetId);
                }
            });
        }

        function mergeNotes(draggedId, targetId) {
            const dragged = allNotes.find(n => n.id === draggedId);
            const target = allNotes.find(n => n.id === targetId);
            
            // Combine text into a bulleted array
            const draggedArr = Array.isArray(dragged.text) ? dragged.text : [dragged.text];
            const targetArr = Array.isArray(target.text) ? target.text : [target.text];
            const combinedText = [...targetArr, ...draggedArr];

            db.ref(`notes/${targetId}`).update({ text: combinedText });
            db.ref(`notes/${draggedId}`).remove();
        }

        // --- MATRIX LOGIC ---
        function syncMatrixUI(nodes) {
            const matrix = document.getElementById('matrix');
            const labels = Array.from(matrix.querySelectorAll('div[class*="absolute"]'));
            matrix.innerHTML = '';
            labels.forEach(l => matrix.appendChild(l));
            if (!nodes) return;
            Object.keys(nodes).forEach(id => {
                const data = nodes[id];
                const note = document.createElement('div');
                note.className = "post-it p-4 w-44 h-44 shadow-2xl rounded font-black text-black text-[11px] flex items-center justify-center text-center leading-tight bg-white border-l-8";
                note.style.borderColor = data.color;
                note.style.transform = `translate(${data.x}px, ${data.y}px)`;
                
                // Show bullets in matrix if merged
                note.innerText = Array.isArray(data.text) ? data.text.join(' | ') : data.text;
                
                matrix.appendChild(note);
                let currentPos = { x: data.x, y: data.y };
                interact(note).draggable({
                    onmove: (e) => {
                        currentPos.x += e.dx; currentPos.y += e.dy;
                        e.target.style.transform = `translate(${currentPos.x}px, ${currentPos.y}px)`;
                    },
                    onend: () => { db.ref(`matrix_nodes/${id}`).update({ x: currentPos.x, y: currentPos.y }); }
                });
            });
        }

        function approveSynthesis() {
            const nodes = {};
            allNotes.forEach((n, i) => {
                const id = 'node_' + Date.now() + '_' + i;
                nodes[id] = { text: n.text, color: n.color, x: 100 + (i * 20), y: 100 + (i * 20) };
            });
            db.ref('matrix_nodes').set(nodes);
            showTab('board');
        }

        // --- SETUP TAB HELPERS ---
        function addCategoryRow() {
            const container = document.getElementById('categoryList');
            const row = document.createElement('div');
            row.className = "flex gap-2 category-row items-center bg-black/40 p-2 rounded border border-gray-800 shadow-sm";
            row.innerHTML = `
                <input type="color" value="#${Math.floor(Math.random()*16777215).toString(16)}" class="w-5 h-5 bg-transparent border-none cursor-pointer">
                <input type="text" value="New Theme" class="flex-1 bg-transparent text-[11px] cat-name font-bold outline-none">
                <button onclick="deleteCategory(this)" class="text-red-500 hover:text-red-300 px-2 font-black transition-colors">✕</button>
            `;
            container.appendChild(row);
        }

        function deleteCategory(btn) { btn.closest('.category-row').remove(); }

        function pushConfig() {
            const steps = document.getElementById('processInput').value.split('\n').filter(s => s.trim() !== "");
            const cats = Array.from(document.querySelectorAll('.category-row')).map(row => ({
                name: row.querySelector('.cat-name').value, color: row.querySelector('input[type="color"]').value
            }));
            db.ref('config').set({ steps, cats }).then(() => alert("Synced!"));
        }

        async function runAiSynthesis() {
            const key = document.getElementById('apiKeyInput').value.trim();
            const btn = document.getElementById('aiBtn');
            const container = document.getElementById('clusterContainer');
            if (!key) return alert("Missing API Key");
            btn.disabled = true;
            container.innerHTML = "<div class='w-full text-center p-20 animate-pulse text-purple-400 font-bold uppercase'>Gemini 2.0 Analyzing...</div>";
            const prompt = `Lean Expert: Group these ${JSON.stringify(allNotes)} into 4 major themes. Return JSON array: [{"title": "Theme Title", "color": "#hex"}]`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { response_mime_type: "application/json" } })
                });
                const result = await response.json();
                let aiText = result.candidates[0].content.parts[0].text;
                const cleanJson = JSON.parse(aiText);
                container.innerHTML = `<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 w-full">` + 
                    cleanJson.map(c => `<div class="cluster-box border-l-4 p-4 bg-gray-900 shadow-xl" style="border-color:${c.color}"><textarea class="master-note-input w-full p-2 bg-white text-black font-black rounded h-24 text-[10px] outline-none" data-color="${c.color}">${c.title}</textarea></div>`).join('') + `</div>`;
                btn.disabled = false;
            } catch (e) { btn.disabled = false; renderRawWall(); }
        }

        function resetEverything() { if(confirm("Wipe all data?")) { db.ref('notes').remove(); db.ref('matrix_nodes').remove(); } }
        function generateTestData() { db.ref('notes').push({ step: "Picking", text: "Hydraulic leak", color: "#fbbf24", timestamp: Date.now() }); }
    </script>
</body>
</html>