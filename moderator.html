<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SiteSolve Pro - Moderator</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-950 text-white font-sans min-h-screen">
    <nav class="bg-gray-900 p-4 border-b border-gray-800 flex gap-4">
        <button onclick="showTab('setup')" class="font-bold text-xs uppercase text-blue-400">1. Setup</button>
        <button onclick="showTab('wall')" class="font-bold text-xs uppercase text-gray-400">2. Live Wall</button>
    </nav>

    <div id="setup" class="p-8 max-w-2xl mx-auto">
        <div class="bg-gray-900 p-6 rounded-2xl border border-white/10 mb-6">
            <input type="text" id="workshopTitle" placeholder="Workshop Name..." class="w-full bg-transparent text-2xl font-black border-b border-gray-800 mb-6 outline-none focus:border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-[10px] font-bold text-gray-500 uppercase">Room Code</p>
                    <p id="roomDisplay" class="text-3xl font-black text-blue-500 tracking-widest">------</p>
                </div>
                <div id="qrcode" class="p-2 bg-white rounded-lg"></div>
            </div>
        </div>
        <button onclick="generateNewRoom()" class="w-full bg-gray-800 py-3 rounded-xl mb-3 font-bold uppercase text-xs">New Room</button>
        <button onclick="pushConfig()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase shadow-lg shadow-blue-900/40">Sync & Start Workshop</button>
    </div>

    <div id="wall" class="p-8 hidden">
        <div id="columnContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyDY7diMSCZc0z2ih1fa2FLx4D47t3LJCIw", 
            authDomain: "issues-app-65527.firebaseapp.com", 
            databaseURL: "https://issues-app-65527-default-rtdb.firebaseio.com", 
            projectId: "issues-app-65527", 
            storageBucket: "issues-app-65527.firebasestorage.app", 
            messagingSenderId: "103649380899", 
            appId: "1:103649380899:web:f8f9131b9a4123d2e93f96" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentRoom = "";

        function generateNewRoom() {
            currentRoom = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('roomDisplay').innerText = currentRoom;
            const baseUrl = window.location.href.split('moderator.html')[0];
            const pUrl = baseUrl + "index.html?room=" + currentRoom;
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: pUrl, width: 100, height: 100 });
            db.ref(`rooms/${currentRoom}/config/roomCode`).set(currentRoom);
        }

        function pushConfig() {
            if(!currentRoom) return alert("Generate a room first!");
            const title = document.getElementById('workshopTitle').value || "Workshop";
            db.ref(`rooms/${currentRoom}/config`).update({
                title: title,
                steps: ["Step 1", "Step 2", "Step 3"],
                cats: [{name: "UX", color: "#3b82f6"}, {name: "Dev", color: "#ef4444"}]
            }).then(() => alert("Sincronizado! El participante ya puede ver los datos."));
        }

        function showTab(id) {
            document.getElementById('setup').classList.toggle('hidden', id !== 'setup');
            document.getElementById('wall').classList.toggle('hidden', id !== 'wall');
            if(id === 'wall') renderWall();
        }

        function renderWall() {
            db.ref(`rooms/${currentRoom}/notes`).on('value', snap => {
                const container = document.getElementById('columnContainer');
                container.innerHTML = "";
                Object.values(snap.val() || {}).forEach(n => {
                    container.innerHTML += `<div class="bg-white text-black p-4 rounded-lg border-l-4" style="border-color:${n.color}">${n.text}</div>`;
                });
            });
        }
        generateNewRoom();
    </script>
</body>
</html>
